---
import '../styles/global.css';
import { generateMetaTags, defaultSiteConfig, getCanonicalUrl, type SEOProps } from '../utils/seo';
import { generatePageSchema, type PageSchemaOptions, type BreadcrumbItem } from '../utils/schema';
import SchemaMarkup from '../components/SchemaMarkup.astro';

interface Props {
  title: string;
  description: string;
  canonical?: string;
  noindex?: boolean;
  nofollow?: boolean;
  ogType?: 'website' | 'article' | 'product';
  ogImage?: string;
  ogImageAlt?: string;
  publishedTime?: string;
  modifiedTime?: string;
  author?: string;
  section?: string;
  tags?: string[];
  breadcrumbs?: BreadcrumbItem[];
  includeOrganization?: boolean;
  includeWebsite?: boolean;
  additionalSchemas?: object[];
}

const {
  title,
  description,
  canonical,
  noindex = false,
  nofollow = false,
  ogType = 'website',
  ogImage,
  ogImageAlt,
  publishedTime,
  modifiedTime,
  author,
  section,
  tags,
  breadcrumbs,
  includeOrganization = false,
  includeWebsite = false,
  additionalSchemas = []
} = Astro.props;

const currentPath = Astro.url.pathname;
const canonicalUrl = canonical || getCanonicalUrl(currentPath);

const seoProps: SEOProps = {
  title,
  description,
  canonical: canonicalUrl,
  noindex,
  nofollow,
  ogType,
  ogImage,
  ogImageAlt,
  publishedTime,
  modifiedTime,
  author,
  section,
  tags
};

const meta = generateMetaTags(seoProps);

const schemaOptions: PageSchemaOptions = {
  url: canonicalUrl,
  title,
  description,
  breadcrumbs,
  datePublished: publishedTime,
  dateModified: modifiedTime,
  image: ogImage ? `${defaultSiteConfig.siteUrl}${ogImage}` : undefined,
  includeOrganization,
  includeWebsite,
  additionalSchemas
};

const schema = generatePageSchema(schemaOptions);
---

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Primary Meta Tags -->
  <title>{meta.title}</title>
  <meta name="title" content={meta.title}>
  <meta name="description" content={meta.description}>
  <link rel="canonical" href={meta.canonical}>
  <meta name="robots" content={meta.robots}>

  <!-- Open Graph / Facebook -->
  <meta property="og:type" content={meta.ogType}>
  <meta property="og:url" content={meta.ogUrl}>
  <meta property="og:title" content={meta.ogTitle}>
  <meta property="og:description" content={meta.ogDescription}>
  <meta property="og:image" content={meta.ogImage}>
  <meta property="og:image:alt" content={meta.ogImageAlt}>
  <meta property="og:site_name" content={meta.ogSiteName}>
  <meta property="og:locale" content={meta.ogLocale}>

  <!-- Twitter -->
  <meta property="twitter:card" content={meta.twitterCard}>
  <meta property="twitter:url" content={meta.ogUrl}>
  <meta property="twitter:title" content={meta.twitterTitle}>
  <meta property="twitter:description" content={meta.twitterDescription}>
  <meta property="twitter:image" content={meta.twitterImage}>
  <meta property="twitter:image:alt" content={meta.twitterImageAlt}>

  <!-- Article-specific (when ogType is 'article') -->
  {meta.articlePublishedTime && <meta property="article:published_time" content={meta.articlePublishedTime}>}
  {meta.articleModifiedTime && <meta property="article:modified_time" content={meta.articleModifiedTime}>}
  {meta.articleAuthor && <meta property="article:author" content={meta.articleAuthor}>}
  {meta.articleSection && <meta property="article:section" content={meta.articleSection}>}
  {meta.articleTags?.map((tag: string) => <meta property="article:tag" content={tag}>)}

  <!-- Favicon -->
  <link rel="icon" type="image/svg+xml" href="/favicon.svg">

  <!-- Preconnect to external resources -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

  <!-- Schema Markup -->
  <SchemaMarkup schemas={schema['@graph']} />

  <slot name="head" />
</head>
<body class="min-h-screen flex flex-col">
  <a href="#main-content" class="skip-link">Skip to main content</a>

  <slot />
</body>
</html>

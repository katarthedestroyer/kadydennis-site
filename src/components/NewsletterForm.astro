---
interface Props {
  formId?: string;
  tags?: string[];
  title?: string;
  description?: string;
  buttonText?: string;
  showName?: boolean;
  variant?: 'default' | 'compact' | 'card';
  class?: string;
}

const {
  formId,
  tags = [],
  title = 'Join the Newsletter',
  description = 'Get weekly tips on AI automation for your travel business.',
  buttonText = 'Subscribe',
  showName = false,
  variant = 'default',
  class: className = ''
} = Astro.props;
---

<div class={`newsletter-signup-form ${variant} ${className}`} data-form-id={formId} data-tags={JSON.stringify(tags)}>
  {variant === 'card' && (
    <div class="bg-brand-50 rounded-xl p-8">
      <h3 class="text-xl font-bold text-gray-900 mb-2">{title}</h3>
      <p class="text-gray-600 mb-6">{description}</p>
      <form class="newsletter-form-element space-y-4">
        {showName && (
          <input
            type="text"
            name="firstName"
            placeholder="First name"
            class="w-full px-4 py-3 rounded-lg border border-gray-200 focus:border-brand-500 focus:ring-2 focus:ring-brand-500/20 outline-none transition-all"
          />
        )}
        <input
          type="email"
          name="email"
          placeholder="Enter your email"
          required
          class="w-full px-4 py-3 rounded-lg border border-gray-200 focus:border-brand-500 focus:ring-2 focus:ring-brand-500/20 outline-none transition-all"
        />
        <button type="submit" class="btn btn-primary w-full">
          {buttonText}
        </button>
      </form>
      <p class="form-message mt-4 text-sm text-center hidden"></p>
    </div>
  )}

  {variant === 'compact' && (
    <div>
      <form class="newsletter-form-element flex flex-col sm:flex-row gap-3">
        <input
          type="email"
          name="email"
          placeholder="Enter your email"
          required
          class="flex-1 px-4 py-2 rounded-lg border border-gray-200 focus:border-brand-500 focus:ring-2 focus:ring-brand-500/20 outline-none transition-all text-sm"
        />
        <button type="submit" class="btn btn-primary btn-sm whitespace-nowrap">
          {buttonText}
        </button>
      </form>
      <p class="form-message mt-3 text-sm text-center hidden"></p>
    </div>
  )}

  {variant === 'default' && (
    <div>
      {title && <h3 class="font-semibold text-gray-900 mb-2">{title}</h3>}
      {description && <p class="text-gray-600 text-sm mb-4">{description}</p>}
      <form class="newsletter-form-element space-y-3">
        {showName && (
          <input
            type="text"
            name="firstName"
            placeholder="First name"
            class="w-full px-4 py-2 rounded-lg border border-gray-200 focus:border-brand-500 focus:ring-2 focus:ring-brand-500/20 outline-none transition-all text-sm"
          />
        )}
        <input
          type="email"
          name="email"
          placeholder="Enter your email"
          required
          class="w-full px-4 py-2 rounded-lg border border-gray-200 focus:border-brand-500 focus:ring-2 focus:ring-brand-500/20 outline-none transition-all text-sm"
        />
        <button type="submit" class="btn btn-primary w-full">
          {buttonText}
        </button>
      </form>
      <p class="form-message mt-3 text-sm hidden"></p>
    </div>
  )}
</div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const forms = document.querySelectorAll('.newsletter-signup-form');

    forms.forEach((container) => {
      const form = container.querySelector('.newsletter-form-element') as HTMLFormElement;
      const message = container.querySelector('.form-message') as HTMLParagraphElement;
      const formId = container.getAttribute('data-form-id');
      const tags = JSON.parse(container.getAttribute('data-tags') || '[]');

      if (!form) return;

      form.addEventListener('submit', async (e) => {
        e.preventDefault();

        const emailInput = form.querySelector('input[name="email"]') as HTMLInputElement;
        const nameInput = form.querySelector('input[name="firstName"]') as HTMLInputElement;
        const submitBtn = form.querySelector('button[type="submit"]') as HTMLButtonElement;

        const email = emailInput?.value;
        const firstName = nameInput?.value || '';

        if (!email) return;

        // Disable form while submitting
        submitBtn.disabled = true;
        submitBtn.textContent = 'Subscribing...';

        try {
          const response = await fetch('/api/subscribe/', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              email,
              firstName,
              formId: formId || undefined,
              tags: tags.length > 0 ? tags : undefined
            })
          });

          const result = await response.json();

          if (response.ok) {
            // Success
            if (message) {
              message.textContent = "You're in! Check your inbox for a welcome email.";
              message.classList.remove('hidden', 'text-red-600');
              message.classList.add('text-green-600');
            }
            form.reset();
          } else {
            // Error
            if (message) {
              message.textContent = result.error || 'Something went wrong. Please try again.';
              message.classList.remove('hidden', 'text-green-600');
              message.classList.add('text-red-600');
            }
          }
        } catch (error) {
          if (message) {
            message.textContent = 'Something went wrong. Please try again.';
            message.classList.remove('hidden', 'text-green-600');
            message.classList.add('text-red-600');
          }
        } finally {
          submitBtn.disabled = false;
          submitBtn.textContent = form.closest('.newsletter-signup-form')?.classList.contains('compact')
            ? 'Subscribe'
            : submitBtn.getAttribute('data-original-text') || 'Subscribe';
        }
      });

      // Store original button text
      const btn = form.querySelector('button[type="submit"]');
      if (btn) {
        btn.setAttribute('data-original-text', btn.textContent || 'Subscribe');
      }
    });
  });
</script>

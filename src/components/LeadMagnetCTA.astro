---
interface Props {
  variant?: 'inline' | 'banner' | 'card';
  title?: string;
  description?: string;
  formId?: string;
  tags?: string[];
}

const {
  variant = 'card',
  title = "Free: The 5 Workflows Every Travel Agent Should Automate",
  description = "Stop reinventing the wheel. Learn which tasks to automate firstâ€”and how to do it without expensive software or a tech team.",
  formId,
  tags = ["15471215"]  // lead-magnet-5-workflows tag
} = Astro.props;
---

{variant === 'banner' && (
  <section class="lead-magnet newsletter-form" data-form-id={formId} data-tags={JSON.stringify(tags)}>
    <div class="flex flex-col md:flex-row items-center justify-between gap-6">
      <div>
        <h2 class="text-xl md:text-2xl font-bold mb-2">{title}</h2>
        <p class="text-white/90">{description}</p>
      </div>
      <div class="w-full md:w-auto">
        <form class="newsletter-form-element flex flex-col sm:flex-row gap-3">
          <input
            type="email"
            name="email"
            placeholder="Your email address"
            required
            class="input-field bg-white/10 border-white/30 text-white placeholder-white/70"
          />
          <button type="submit" class="btn btn-white whitespace-nowrap font-semibold">
            Get the Guide
          </button>
        </form>
        <p class="form-message mt-2 text-sm text-center hidden"></p>
      </div>
    </div>
  </section>
)}

{variant === 'card' && (
  <section class="glass-card p-8 md:p-12 newsletter-form" data-form-id={formId} data-tags={JSON.stringify(tags)}>
    <div class="max-w-2xl mx-auto text-center">
      <span class="badge badge-accent mb-4">Free Resource</span>
      <h2 class="text-2xl md:text-3xl font-bold text-white mb-4">{title}</h2>
      <p class="text-gray-400 mb-8">{description}</p>
      <form class="newsletter-form-element flex flex-col sm:flex-row gap-3 max-w-md mx-auto">
        <input
          type="email"
          name="email"
          placeholder="Your email address"
          required
          class="input-field flex-grow"
        />
        <button type="submit" class="btn btn-primary whitespace-nowrap">
          Send Me the Guide
        </button>
      </form>
      <p class="form-message mt-4 text-sm hidden"></p>
      <p class="text-sm text-gray-500 mt-4">No spam. Unsubscribe anytime.</p>
    </div>
  </section>
)}

{variant === 'inline' && (
  <div class="glass-card p-6 border-accent-500/30 newsletter-form" data-form-id={formId} data-tags={JSON.stringify(tags)}>
    <h3 class="font-bold text-white mb-2">{title}</h3>
    <p class="text-gray-400 text-sm mb-4">{description}</p>
    <form class="newsletter-form-element flex flex-col sm:flex-row gap-3">
      <input
        type="email"
        name="email"
        placeholder="Your email"
        required
        class="input-field text-sm flex-grow"
      />
      <button type="submit" class="btn btn-primary btn-sm whitespace-nowrap">
        Get Free Guide
      </button>
    </form>
    <p class="form-message mt-3 text-sm hidden"></p>
  </div>
)}

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const forms = document.querySelectorAll('.newsletter-form');

    forms.forEach((container) => {
      const form = container.querySelector('.newsletter-form-element') as HTMLFormElement;
      const message = container.querySelector('.form-message') as HTMLParagraphElement;
      const formId = container.getAttribute('data-form-id');
      const tags = JSON.parse(container.getAttribute('data-tags') || '[]');

      if (!form) return;

      form.addEventListener('submit', async (e) => {
        e.preventDefault();

        const emailInput = form.querySelector('input[name="email"]') as HTMLInputElement;
        const nameInput = form.querySelector('input[name="firstName"]') as HTMLInputElement;
        const submitBtn = form.querySelector('button[type="submit"]') as HTMLButtonElement;

        const email = emailInput?.value;
        const firstName = nameInput?.value || '';
        const originalText = submitBtn.textContent;

        if (!email) return;

        // Disable form while submitting
        submitBtn.disabled = true;
        submitBtn.textContent = 'Sending...';

        try {
          const response = await fetch('/api/subscribe/', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              email,
              firstName,
              formId: formId || undefined,
              tags: tags.length > 0 ? tags : undefined
            })
          });

          const result = await response.json();

          if (response.ok) {
            // Success
            if (message) {
              message.textContent = 'Check your email for the guide!';
              message.classList.remove('hidden', 'text-rose-400');
              message.classList.add('text-accent-400');
            }
            form.reset();
          } else {
            // Error
            if (message) {
              message.textContent = result.error || 'Something went wrong. Please try again.';
              message.classList.remove('hidden', 'text-accent-400');
              message.classList.add('text-rose-400');
            }
          }
        } catch (error) {
          if (message) {
            message.textContent = 'Something went wrong. Please try again.';
            message.classList.remove('hidden', 'text-accent-400');
            message.classList.add('text-rose-400');
          }
        } finally {
          submitBtn.disabled = false;
          submitBtn.textContent = originalText;
        }
      });
    });
  });
</script>
